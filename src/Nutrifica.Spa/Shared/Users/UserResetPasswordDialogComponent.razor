@using System.ComponentModel.DataAnnotations
@using Nutrifica.Api.Contracts.Users.Requests
@using Nutrifica.Api.Contracts.Users.Responses
@using Nutrifica.Shared.Wrappers
@using Nutrifica.Spa.Infrastructure.Services.Users
@inject IUserService UserService
@implements IDisposable

<EditForm
    EditContext="_editContext"
    OnValidSubmit="Submit">
    <MudDialog>
        <DialogContent>
            <DataAnnotationsValidator/>
            @* <ValidationSummary/> *@
            @* <ApiResponseAlert Visible="@_showError" Error="@_error"/> *@

            <MudTextField Label="Пароль"
                          @bind-Value="_model.Password"
                          InputType="InputType.Password"
                          For="() => _model.Password"
                          Required="true"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          RequiredError="Это поле обязательно к заполнению"/>
            @* <ValidationMessage For="() => _model.Password"/> *@

            <MudTextField Label="Подтверждение пароля"
                          @bind-Value="_model.ConfirmPassword"
                          InputType="InputType.Password"
                          For="() => _model.ConfirmPassword"
                          Required="true"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          RequiredError="Это поле обязательно к заполнению"/>
            @* <ValidationMessage For="() => _model.ConfirmPassword"/> *@

        </DialogContent>

        <DialogActions>
            <MudButton
                OnClick="CloseWindowAsCancel">
                Отменить
            </MudButton>

            <MudButton
                ButtonType="ButtonType.Submit"
                Variant="Variant.Filled"
                Color="Color.Primary">
                Обновить
            </MudButton>
        </DialogActions>
    </MudDialog>
</EditForm>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public UserResponse User { get; set; } = null!;
    private EditContext _editContext = null!;
    private ResetPasswordModel _model = null!;
    private ValidationMessageStore _messageStore = null!;
    private CancellationTokenSource _cts = new();

    protected override void OnInitialized()
    {
        _model = new();
        _editContext = new EditContext(_model);
        _editContext.OnValidationRequested += HandleValidationRequested;
        _messageStore = new ValidationMessageStore(_editContext);
    }

    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs e)
    {
        _messageStore?.Clear();
    }

    async Task Submit()
    {
        var request = new UserResetPasswordRequest(
            User.Id,
            _model.Password
        );

        var result = await UserService
            .ResetPasswordAsync(request, _cts.Token);

        if (result.IsFailure)
        {
            _messageStore.Add(() => _model, result.Error.Description);
            StateHasChanged();
            return;
        }

        MudDialog.Close(DialogResult.Ok(true));
    }

    void CloseWindowAsCancel() => MudDialog.Cancel();

    public void Dispose()
    {
        _editContext.OnValidationRequested -= HandleValidationRequested;
        _cts.Cancel();
        _cts.Dispose();
    }

    class ResetPasswordModel
    {
        [Required(AllowEmptyStrings = false, ErrorMessage = "Пароль не может быть пустым")]
        [StringLength(50, MinimumLength = 6, ErrorMessage = "Длина должна быть от 6 до 50 символов.")]
        public string Password { get; set; } = string.Empty;

        [Required(AllowEmptyStrings = false, ErrorMessage = "Пароль не может быть пустым")]
        [StringLength(50, MinimumLength = 6, ErrorMessage = "Длина должна быть от 6 до 50 символов.")]
        [Compare(nameof(Password), ErrorMessage = "Пароль не совпадает.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

}