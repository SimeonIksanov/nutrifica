@using Nutrifica.Api.Contracts.Clients
@using Nutrifica.Spa.Infrastructure.Models
@using Nutrifica.Spa.Infrastructure.Routes
@using Nutrifica.Spa.Infrastructure.Services.Clients
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IClientService ClientService
@inject NavigationManager NavigationManager
@implements IDisposable

<MudContainer
    Gutters="true"
    MaxWidth="MaxWidth.False">

    <MudDataGrid RowClick="@RowClicked"
                 T="ClientDto"
                 @ref="_dataGrid"
                 Dense="true"
                 Striped="true"
                 Bordered="true"
                 Outlined="false"
                 Elevation="0"
                 ColumnResizeMode="ResizeMode.Column"
                 ServerData="FetchClientsAsync"
                 Filterable="true"
                 FilterMode="DataGridFilterMode.Simple">

        <ToolBarContent>
            <MudToolBar Class="gap-2">
                <MudButton
                    @onclick="OnAddClick"
                    Variant="Variant.Outlined"
                    Size="Size.Small">
                    Создать
                </MudButton>

                <MudButton
                    @onclick="OnRefreshClick"
                    Variant="Variant.Outlined"
                    Size="Size.Small">
                    Обновить
                </MudButton>
            </MudToolBar>
        </ToolBarContent>

        <Columns>
            <HierarchyColumn T="ClientDto"/>
            <PropertyColumn Property="x => x.LastName" Title="Фамилия"/>
            <PropertyColumn Property="x => x.FirstName" Title="Имя"/>
            <PropertyColumn Property="x => x.MiddleName" Title="Отчество"/>
            <PropertyColumn Property="x => x.PhoneNumber" Title="Номер Телефона"/>
            <PropertyColumn Property="x => x.Comment" Title="Комментарий">
                <CellTemplate>@ShortComment(context.Item)</CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Source" Title="Источник" Hideable="true"/>
            <PropertyColumn Property="x => x.State" Title="Состояние"/>
        </Columns>

        <ChildRowContent>
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">@context.Item.FullName</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudText>Создан @context.Item.CreatedAt</MudText>
                    <MudText>Адрес: @context.Item.Address.Country @context.Item.Address.ZipCode @context.Item.Address.Region @context.Item.Address.City @context.Item.Address.Street @context.Item.Address.Comment</MudText>
                    <MudText>Комментарий: @context.Item.Comment</MudText>
                </MudCardContent>
            </MudCard>
        </ChildRowContent>

        <NoRecordsContent>
            <MudText>Клиенты не найдены</MudText>
        </NoRecordsContent>

        <LoadingContent>
            <MudText>Загрузка...</MudText>
        </LoadingContent>

        <PagerContent>
            <MudDataGridPager T="ClientDto"
                              RowsPerPageString="Строк на странице"
                              InfoFormat="{first_item}-{last_item} из {all_items}"/>
        </PagerContent>

    </MudDataGrid>

</MudContainer>

@code {
    private MudDataGrid<ClientDto> _dataGrid = null!;
    private CancellationTokenSource _cancellationTokenSource = new();

    private async Task<GridData<ClientDto>> FetchClientsAsync(GridState<ClientDto> state)
    {
        var queryParams = new QueryParams
        {
            Page = state.Page + 1,
            PageSize = state.PageSize
        };
        // ApplyFilters(state, queryParams);
        ApplySorts(state, queryParams);

        var result = await ClientService.GetAsync(queryParams, _cancellationTokenSource.Token);
        if (result.IsFailure)
        {
            Snackbar.Add(result.Error.Description, Severity.Error);
            return new GridData<ClientDto>();
        }

        return new GridData<ClientDto>
        {
            Items = result.Value.Items,
            TotalItems = result.Value.TotalCount
        };
    }

    private void RowClicked(DataGridRowClickEventArgs<ClientDto> eventArgs)
    {
        NavigationManager.NavigateTo(PageUrls.ClientDetails(eventArgs.Item.Id));
    }

    public void Dispose()
    {
        _cancellationTokenSource.CancelAsync();
        _cancellationTokenSource.Dispose();
    }

    private async Task OnAddClick()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            BackdropClick = false,
            Position = DialogPosition.TopCenter,
            CloseOnEscapeKey = true
        };
        var dialog = await DialogService.ShowAsync<ClientAddDialogComponent>("Регистрация клиента", options);
        var result = await dialog.Result;

        if (result is null || result.Canceled) return;

        if (result.Data is ClientDto)
        {
            Snackbar.Add("Пользователь создан", Severity.Success);
            _ = _dataGrid.ReloadServerData();
        }
    }

    private string ShortComment(ClientDto client)
    {
        int maxLength = 50;
        if (client.Comment.Length < 50)
            return client.Comment;

        string x = $"{client.Comment.Substring(0, maxLength)}...";
        return x;
    }

    private async Task OnRefreshClick()
    {
        await _dataGrid.ReloadServerData();
    }

    private static void ApplySorts(GridState<ClientDto> state, QueryParams queryParams)
    {
        if (state.SortDefinitions.Count > 0)
            queryParams.Sorts = state.SortDefinitions
                .Select(x => x.Descending ? $"-{x.SortBy}" : x.SortBy)
                // .Aggregate("", (a, b) => string.Join(",", a, b));
                .Aggregate((a, b) => string.Join(",", a, b));
    }

}