@using Nutrifica.Api.Contracts.Clients
@using Nutrifica.Api.Contracts.Users.Responses
@using Nutrifica.Shared.Enums
@using Nutrifica.Spa.Infrastructure.Services.Clients
@using Nutrifica.Spa.Infrastructure.Services.Users
@implements IDisposable
@inject IClientService ClientService
@inject IUserService UserService

<EditForm EditContext="_editContext"
          OnValidSubmit="OnSubmitAsync">
    <MudDialog>
        <DialogContent>
            <DataAnnotationsValidator/>
            <ValidationSummary/>

            <MudTextField Label="Фамилия"
                          @bind-Value="_model.LastName"
                          For="() => _model.LastName"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Class="my-2"/>

            <MudTextField Label="Имя"
                          @bind-Value="_model.FirstName"
                          For="() => _model.FirstName"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Class="my-2"/>

            <MudTextField Label="Отчество"
                          @bind-Value="_model.MiddleName"
                          For="() => _model.MiddleName"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Class="my-2"/>

            <MudTextField Label="Телефон"
                          @bind-Value="_model.PhoneNumber"
                          For="() => _model.PhoneNumber"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Class="my-2"/>

            <MudTextField Label="Источник"
                          @bind-Value="_model.Source"
                          For="() => _model.Source"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Class="my-2"/>

            <MudTextField Label="Комментарий"
                          @bind-Value="_model.Comment"
                          For="() => _model.Comment"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Class="my-2"/>

            <MudSelect Label="Состояние"
                       @bind-Value="_model.State"
                       T="State"
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Dense="true"
                       Class="my-2">
                <MudSelectItem Value="State.Active">Активный</MudSelectItem>
                <MudSelectItem Value="State.Archived">Архивирован</MudSelectItem>
                <MudSelectItem Value="State.Deleted">Удален</MudSelectItem>
            </MudSelect>


            <MudDivider/>
            <MudExpansionPanels Class="my-1">
                <MudExpansionPanel Text="Адрес" Expanded="false">
                    <MudTextField Label="Страна"
                                  @bind-Value="_model.Address.Country"
                                  For="() => _model.Address.Country"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Class="my-2"/>

                    <MudTextField Label="Регион"
                                  @bind-Value="_model.Address.Region"
                                  For="() => _model.Address.Region"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Class="my-2"/>

                    <MudTextField Label="Город"
                                  @bind-Value="_model.Address.City"
                                  For="() => _model.Address.City"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Class="my-2"/>

                    <MudTextField Label="Улица"
                                  @bind-Value="_model.Address.Street"
                                  For="() => _model.Address.Street"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Class="my-2"/>

                    <MudTextField Label="Индекс"
                                  @bind-Value="_model.Address.ZipCode"
                                  For="() => _model.Address.ZipCode"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Class="my-2"/>

                    <MudTextField Label="Комментарий"
                                  @bind-Value="_model.Address.Comment"
                                  For="() => _model.Address.Comment"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Class="my-2"/>
                </MudExpansionPanel>

                <MudExpansionPanel Text="Менеджеры" MaxHeight="150" Expanded="false">
                    @foreach (var item in _selectableManagers)
                    {
                        <MudCheckBox Label=@item.Name @bind-Value="@item.Selected"/>
                    }
                </MudExpansionPanel>
            </MudExpansionPanels>

        </DialogContent>

        <DialogActions>
            <MudButton
                OnClick="CloseWindowAsCancel">
                Отменить
            </MudButton>

            <MudButton
                ButtonType="ButtonType.Submit"
                Variant="Variant.Filled"
                Color="Color.Primary">
                Изменить
            </MudButton>
        </DialogActions>

    </MudDialog>
</EditForm>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public ClientDto Client { get; set; } = null!;
    private ValidationMessageStore _messageStore = null!;
    private readonly ClientUpdateDto _model = new();
    private EditContext _editContext = null!;
    private readonly CancellationTokenSource _cts = new();
    private ICollection<SelectableManager> _selectableManagers = [];

    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(_model);
        _editContext.OnValidationRequested += HandleValidationRequested;
        _messageStore = new ValidationMessageStore(_editContext);
        MapIncomingClientToFormModel();
        // _selectableManagers = await GetSelectableManagersAsync(Client.Managers, _cts.Token);
    }


    void CloseWindowAsCancel() => MudDialog.Cancel();

    public void Dispose()
    {
        _editContext.OnValidationRequested -= HandleValidationRequested;
        _cts.CancelAsync();
        _cts.Dispose();
    }

    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs e)
    {
        _messageStore.Clear();
    }

    private void MapIncomingClientToFormModel()
    {
        if (Client is null) return;
        _model.Id = Client.Id;
        _model.FirstName = Client.FirstName;
        _model.MiddleName = Client.MiddleName;
        _model.LastName = Client.LastName;
        _model.PhoneNumber = Client.PhoneNumber;
        _model.Comment = Client.Comment;
        _model.Source = Client.Source;
        _model.State = Client.State;
        _model.Address = Client.Address with { };
    }

    private async Task OnSubmitAsync()
    {
        _model.ManagerIds = _selectableManagers
            .Where(x => x.Selected)
            .Select(x => x.User.Id)
            .ToList();
        var result = await ClientService.UpdateAsync(_model, _cts.Token);
        if (result.IsFailure)
        {
            _messageStore.Add(() => _model, result.Error.Description);
            _editContext.NotifyValidationStateChanged();
            return;
        }

        MudDialog.Close(DialogResult.Ok(result.Value));
    }

    // private async Task<ICollection<SelectableManager>> GetSelectableManagersAsync(ICollection<UserShortDto> currentManagers, CancellationToken ct)
    // {
    //     var managers = await LoadManagersAsync(ct);
    //     var selectable = new List<SelectableManager>(managers.Count);
    //     var currentIds = currentManagers.Select(x => x.Id).ToArray();
    //     foreach (var manager in managers)
    //     {
    //         SelectableManager val = currentIds.Contains(manager.Id)
    //             ? new(manager, true)
    //             : new(manager, false);
    //         selectable.Add(val);
    //     }
    //
    //     return selectable;
    // }

    private async Task<ICollection<UserShortDto>> LoadManagersAsync(CancellationToken ct)
    {
        var managerResult = await UserService.GetManagersAsync(ct);
        return managerResult.IsSuccess
            ? managerResult.Value
            : [];
    }

    record SelectableManager(UserShortDto User, bool Selected)
    {
        //public UserShortDto User { get; init; } = User;
        public bool Selected { get; set; } = Selected;
        public string Name => $"{User.LastName} {User.FirstName} {User.MiddleName}";
    }

}